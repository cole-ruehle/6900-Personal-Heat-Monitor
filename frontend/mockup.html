<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Campus Temperature Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <style>
    :root{
      --bg:#ffffff;
      --text:#0b0f17;
      --muted:#667085;
      --border:#e5e7eb;
      --panel:#ffffff;
      --soft:#f8fafc;

      /* MIT red accent (used sparingly) */
      --accent:#a31f34;

      --hot:#d92d20;      /* red */
      --neutral:#98a2b3;  /* gray */
      --cool:#12b76a;     /* green */

      --radius:6px;       /* sharp-ish */
      --shadow: 0 6px 18px rgba(16,24,40,.08); /* subtle */
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:var(--bg);
    }

    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px 16px 32px;
    }

    /* Top bar */
    .topbar{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:16px;
      padding: 10px 0 16px;
      border-bottom: 2px solid var(--border);
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    h1{
      margin:0;
      font-size:22px;
      font-weight:800;
      letter-spacing:-.2px;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
      max-width: 760px;
    }
    .status{
      color:var(--muted);
      font-size:12px;
      font-family:var(--mono);
      white-space:nowrap;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
    }
    .status .live{
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .status .dot{
      width:8px;height:8px;border-radius:50%;
      background: var(--accent);
    }
    .navLink{
      display:inline-flex;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background:#fff;
      color: var(--muted);
      font-weight:900;
      text-decoration:none;
    }
    .navLink:hover{
      background: var(--soft);
      border-color:#d0d5dd;
      color: var(--text);
    }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 16px;
      margin-top: 16px;
      align-items:start;
    }

    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 12px 14px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: #fff;
    }
    .card .hd h2{
      margin:0;
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color: var(--muted);
      font-weight:800;
    }
    .card .bd{ padding: 14px; }

    /* KPI row */
    .kpiRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      padding: 14px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: var(--soft);
    }
    .kpiMain{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .bigTemp{
      font-size:44px;
      font-weight:900;
      letter-spacing:-.6px;
      line-height:1;
    }
    .delta{
      font-size:13px;
      font-weight:800;
      color: var(--hot);
    }
    .smallMeta{
      font-size:12px;
      color: var(--muted);
      font-family: var(--mono);
    }

    .btn{
      appearance:none;
      border:1px solid var(--border);
      background:#fff;
      color: var(--text);
      padding: 10px 12px;
      border-radius: 6px;
      font-weight:800;
      font-size:12px;
      cursor:pointer;
      transition: background .12s ease, border-color .12s ease, transform .06s ease;
      white-space:nowrap;
    }
    .btn:hover{ background: var(--soft); border-color:#d0d5dd; }
    .btn:active{ transform: translateY(1px); }

    .btn.accent{
      border-color: rgba(163,31,52,.35);
      background: rgba(163,31,52,.06);
      color: var(--accent);
    }

    /* Legend */
    .legend{
      display:grid;
      gap:10px;
      margin-top: 14px;
    }
    .legItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      background:#fff;
    }
    .legLeft{ display:flex; align-items:center; gap:10px; }
    .swatch{
      width:10px;height:10px;border-radius:2px;
      flex:0 0 auto;
    }
    .legText{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .legName{ font-size:13px; font-weight:800; }
    .legHint{ font-size:12px; color:var(--muted); font-family:var(--mono); }

    .tag{
      font-size:11px;
      font-weight:900;
      letter-spacing:.06em;
      text-transform:uppercase;
      padding: 6px 8px;
      border-radius: 999px;
      border:1px solid var(--border);
      color: var(--muted);
      background: #fff;
      white-space:nowrap;
    }
    .tag.go{ border-color: rgba(18,183,106,.35); color: var(--cool); background: rgba(18,183,106,.06); }
    .tag.avoid{ border-color: rgba(217,45,32,.35); color: var(--hot); background: rgba(217,45,32,.06); }

    /* Lists */
    .list{
      margin-top: 14px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
      background:#fff;
    }
    .list .lh{
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--border);
      background: #fff;
    }
    .list .lh .name{
      font-size:12px;
      font-weight:900;
      letter-spacing:.08em;
      text-transform:uppercase;
      color: var(--muted);
    }
    .rows{
      padding: 8px 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px;
      border:1px solid var(--border);
      border-radius: 6px;
      background: #fff;
    }
    .row .left{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 0;
    }
    .row .title{
      font-size:13px;
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .row .meta{
      font-size:12px;
      color: var(--muted);
      font-family: var(--mono);
    }
    .badge{
      font-family: var(--mono);
      font-size:12px;
      font-weight:900;
      padding: 6px 8px;
      border-radius: 6px;
      border:1px solid var(--border);
      background: var(--soft);
      white-space:nowrap;
    }
    .badge.hot{ border-color: rgba(217,45,32,.35); color: var(--hot); background: rgba(217,45,32,.06); }
    .badge.cool{ border-color: rgba(18,183,106,.35); color: var(--cool); background: rgba(18,183,106,.06); }

    /* Map */
    .mapShell{ padding:0; }
    .mapTop{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      border-bottom:1px solid var(--border);
      background:#fff;
    }
    .mapTop .left{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .mapTop .left .t{
      font-size:12px;
      font-weight:900;
      letter-spacing:.08em;
      text-transform:uppercase;
      color: var(--muted);
    }
    .mapTop .left .s{
      font-size:13px;
      color: var(--muted);
    }

    .map{
      height: 640px;
      background: #fff;
    }

    .leaflet-container{ font-family: var(--sans); }

    /* Small helper text */
    .hint{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      font-family: var(--mono);
      line-height: 1.35;
    }

    /* Chart area */
    .chartWrap{
      padding: 10px 12px;
      border:1px solid var(--border);
      border-radius: 6px;
      background: #fff;
    }
    .chartBox{
      position:relative;
      height: 220px;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .map{ height: 520px; }
      .chartBox{ height: 200px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>Campus Temperature Dashboard</h1>
        <p class="subtitle">
          Goal: help students decide <b>where to avoid</b> (hot spots) and <b>where to go</b> (cool spots) while walking around campus.
        </p>
      </div>
      <div class="status">
        <a class="navLink" href="/">Home</a>
        <a class="navLink" href="/about">About</a>
        <span class="live"><span class="dot"></span><span id="updatedText">Updated 4:51 PM • Live</span></span>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="hd">
          <h2>Overview</h2>
          <button class="btn accent" id="refreshBtn">Refresh</button>
        </div>
        <div class="bd">
          <div class="kpiRow">
            <div class="kpiMain">
              <div class="bigTemp" id="tempValue">--°F</div>
              <div class="delta" id="hiValue">Hottest: —</div>
              <div class="smallMeta" id="metaValue">Window: — • Readings: —</div>
            </div>
            <div style="text-align:right">
              <div class="smallMeta" id="coolestValue">Coolest: —</div>
              <div class="smallMeta" id="countValue">Areas: —</div>
            </div>
          </div>

          <div class="legend">
            <div class="legItem">
              <div class="legLeft">
                <div class="swatch" style="background:var(--hot)"></div>
                <div class="legText">
                  <div class="legName">Hot</div>
                  <div class="legHint">≥ 85°F</div>
                </div>
              </div>
              <span class="tag avoid">hot</span>
            </div>

            <div class="legItem">
              <div class="legLeft">
                <div class="swatch" style="background:var(--neutral)"></div>
                <div class="legText">
                  <div class="legName">Neutral</div>
                  <div class="legHint">76–84°F</div>
                </div>
              </div>
              <span class="tag">ok</span>
            </div>

            <div class="legItem">
              <div class="legLeft">
                <div class="swatch" style="background:var(--cool)"></div>
                <div class="legText">
                  <div class="legName">Cool</div>
                  <div class="legHint">≤ 75°F</div>
                </div>
              </div>
              <span class="tag go">cool</span>
            </div>
          </div>

          <div class="list">
            <div class="lh">
              <div class="name">Areas</div>
              <span class="tag">click area</span>
            </div>
            <div class="rows" id="areaList"></div>
          </div>

          <div class="list">
            <div class="lh">
              <div class="name">Area time series</div>
              <span class="tag">avg temp + humidity</span>
            </div>
            <div class="rows">
              <div class="chartWrap">
                <div class="chartBox">
                  <canvas id="seriesChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card mapShell">
        <div class="mapTop">
          <div class="left">
            <div class="t">Campus Map</div>
            <div class="s">Area averages from readings within each bounding box. Click an area for details.</div>
          </div>
          <button class="btn" id="recenterBtn">Recenter</button>
        </div>

        <div class="map" id="map"></div>
      </div>

    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    const MIT_CENTER = [42.3601, -71.0942];
    const WINDOW_MINUTES = 30;
    const SERIES_BUCKET_MINUTES = 10;
    const SERIES_HOURS = 6;

    const updatedText = document.getElementById("updatedText");
    const tempValue = document.getElementById("tempValue");
    const hiValue = document.getElementById("hiValue");
    const metaValue = document.getElementById("metaValue");
    const coolestValue = document.getElementById("coolestValue");
    const countValue = document.getElementById("countValue");

    const areaList = document.getElementById("areaList");

    const refreshBtn = document.getElementById("refreshBtn");
    const recenterBtn = document.getElementById("recenterBtn");

    function fmtClockFromMs(ms){
      if(ms == null) return "—";
      return new Intl.DateTimeFormat(undefined, { hour: "numeric", minute: "2-digit" }).format(new Date(ms));
    }

    function tempKind(tempF){
      if(tempF >= 85) return "hot";
      if(tempF <= 75) return "cool";
      return "neutral";
    }

    const COLORS = {
      hot: "#d92d20",
      cool: "#12b76a",
      neutral: "#98a2b3",
      accent: "#a31f34",
      dark: "rgba(16,24,40,.72)"
    };

    const map = L.map("map", { zoomControl: true }).setView(MIT_CENTER, 16);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap"
    }).addTo(map);

    let areaRects = new Map(); // area_id -> L.Rectangle
    let selectedAreaId = null;
    let lastAreas = [];

    let chart = null;
    const ctx = document.getElementById("seriesChart").getContext("2d");

    function ensureChart(){
      if(chart) return chart;
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Avg temp (°F)",
              data: [],
              borderColor: "rgba(163,31,52,.85)",
              backgroundColor: "rgba(163,31,52,.10)",
              tension: 0.25,
              pointRadius: 0,
              yAxisID: "yTemp"
            },
            {
              label: "Avg humidity (%RH)",
              data: [],
              borderColor: "rgba(79,147,173,.95)",
              backgroundColor: "rgba(79,147,173,.10)",
              tension: 0.25,
              pointRadius: 0,
              yAxisID: "yRh"
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: { display: true, labels: { boxWidth: 12 } },
            tooltip: { enabled: true }
          },
          scales: {
            x: { ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 8 } },
            yTemp: { position: "left", title: { display: true, text: "°F" } },
            yRh: { position: "right", grid: { drawOnChartArea: false }, min: 0, max: 100, title: { display: true, text: "%RH" } }
          }
        }
      });
      return chart;
    }

    function setCampusSummary(summary){
      if(summary.avg_temp_f != null){
        tempValue.textContent = `${Math.round(summary.avg_temp_f)}°F`;
      } else {
        tempValue.textContent = `--°F`;
      }

      if(summary.hottest_area){
        hiValue.textContent = `Hottest: ${summary.hottest_area.name} (${Math.round(summary.hottest_area.avg_temp_f)}°F)`;
      } else {
        hiValue.textContent = "Hottest: —";
      }

      if(summary.coolest_area){
        coolestValue.textContent = `Coolest: ${summary.coolest_area.name} (${Math.round(summary.coolest_area.avg_temp_f)}°F)`;
      } else {
        coolestValue.textContent = "Coolest: —";
      }

      metaValue.textContent = `Window: ${summary.window_minutes} min • Readings: ${summary.n_readings_total}`;
      countValue.textContent = `Areas: ${lastAreas.length || "—"}`;
      updatedText.textContent = `Updated ${fmtClockFromMs(summary.timestamp_ms)} • Local`;
    }

    async function fetchJson(url){
      const res = await fetch(url, { headers: { "Accept": "application/json" } });
      if(!res.ok){
        throw new Error(`${res.status} ${res.statusText}`);
      }
      return await res.json();
    }

    function renderAreaList(areas){
      areaList.innerHTML = "";
      areas.forEach(a => {
        const row = document.createElement("div");
        row.className = "row";
        row.style.cursor = "pointer";

        const left = document.createElement("div");
        left.className = "left";
        left.innerHTML = `
          <div class="title">${a.name}</div>
          <div class="meta">${a.n_readings} readings • ${fmtClockFromMs(a.timestamp_ms)}</div>
        `;

        const badge = document.createElement("div");
        const kind = a.avg_temp_f == null ? "neutral" : tempKind(a.avg_temp_f);
        badge.className = "badge " + (kind === "hot" ? "hot" : (kind === "cool" ? "cool" : ""));
        badge.textContent = a.avg_temp_f == null ? "—" : `${Math.round(a.avg_temp_f)}°F`;

        row.addEventListener("click", () => selectArea(a));
        row.appendChild(left);
        row.appendChild(badge);
        areaList.appendChild(row);
      });
    }

    function rectStyleForArea(a, selected){
      const kind = a.avg_temp_f == null ? "neutral" : tempKind(a.avg_temp_f);
      const stroke = kind === "hot" ? COLORS.hot : (kind === "cool" ? COLORS.cool : COLORS.neutral);
      return {
        color: selected ? COLORS.accent : stroke,
        weight: selected ? 3 : 2,
        opacity: 0.85,
        fillColor: stroke,
        fillOpacity: selected ? 0.22 : 0.14
      };
    }

    async function selectArea(area){
      selectedAreaId = area.area_id;

      for(const a of lastAreas){
        const rect = areaRects.get(a.area_id);
        if(rect) rect.setStyle(rectStyleForArea(a, a.area_id === selectedAreaId));
      }

      const popupHtml = `
        <div style="min-width:220px">
          <div style="font-weight:950; margin-bottom:6px">${area.name}</div>
          <div style="font-family: var(--mono); font-size:12px; color:${COLORS.dark}; line-height:1.35">
            Avg temp: <b>${area.avg_temp_f == null ? "—" : Math.round(area.avg_temp_f) + "°F"}</b><br/>
            Avg RH: <b>${area.avg_humidity_rh == null ? "—" : Math.round(area.avg_humidity_rh) + "%"}</b><br/>
            Heat index: <b>${area.avg_heat_index_f == null ? "—" : Math.round(area.avg_heat_index_f) + "°F"}</b><br/>
            Readings: <b>${area.n_readings}</b><br/>
            Updated: <b>${fmtClockFromMs(area.timestamp_ms)}</b>
          </div>
        </div>
      `;

      const rect = areaRects.get(area.area_id);
      if(rect){
        rect.bindPopup(popupHtml).openPopup();
      }

      const seriesResp = await fetchJson(`/api/dr1/areas/${encodeURIComponent(area.area_id)}/series?bucket_minutes=${SERIES_BUCKET_MINUTES}&hours=${SERIES_HOURS}`);
      const series = seriesResp.series || [];
      const labels = series.map(p => fmtClockFromMs(p.timestamp_ms));
      const temps = series.map(p => p.avg_temp_f);
      const rhs = series.map(p => p.avg_humidity_rh);

      const ch = ensureChart();
      ch.data.labels = labels;
      ch.data.datasets[0].data = temps;
      ch.data.datasets[1].data = rhs;
      ch.update();
    }

    async function loadAreasAndSummary(){
      const [areas, summary] = await Promise.all([
        fetchJson(`/api/dr1/areas?window_minutes=${WINDOW_MINUTES}`),
        fetchJson(`/api/dr1/campus/summary?window_minutes=${WINDOW_MINUTES}`)
      ]);

      lastAreas = areas;
      renderAreaList(areas);
      setCampusSummary(summary);

      for(const a of areas){
        const bounds = [
          [a.bounds.min_lat, a.bounds.min_lon],
          [a.bounds.max_lat, a.bounds.max_lon]
        ];

        if(!areaRects.has(a.area_id)){
          const rect = L.rectangle(bounds, rectStyleForArea(a, false)).addTo(map);
          rect.on("click", () => selectArea(a));
          rect.bindTooltip(`${a.name}`, { sticky: true });
          areaRects.set(a.area_id, rect);
        } else {
          const rect = areaRects.get(a.area_id);
          rect.setBounds(bounds);
          rect.setStyle(rectStyleForArea(a, a.area_id === selectedAreaId));
        }
      }

      for(const [areaId, rect] of areaRects.entries()){
        if(!areas.find(x => x.area_id === areaId)){
          rect.remove();
          areaRects.delete(areaId);
        }
      }

      if(!selectedAreaId && areas.length > 0){
        await selectArea(areas[0]);
      } else if(selectedAreaId){
        const current = areas.find(x => x.area_id === selectedAreaId);
        if(current) await selectArea(current);
      }
    }

    refreshBtn.addEventListener("click", () => {
      loadAreasAndSummary().catch(err => {
        updatedText.textContent = `Error loading data: ${String(err)}`;
      });
    });

    recenterBtn.addEventListener("click", () => {
      if(lastAreas.length === 0){
        map.setView(MIT_CENTER, 16);
        return;
      }
      const all = [];
      for(const a of lastAreas){
        all.push([a.bounds.min_lat, a.bounds.min_lon]);
        all.push([a.bounds.max_lat, a.bounds.max_lon]);
      }
      const b = L.latLngBounds(all);
      map.fitBounds(b.pad(0.10));
    });

    loadAreasAndSummary().catch(err => {
      updatedText.textContent = `Error loading data: ${String(err)}`;
    });
  </script>
</body>
</html>
